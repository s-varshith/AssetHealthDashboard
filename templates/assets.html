{% extends 'base.html' %}
{% block title %}Assets{% endblock %}

{% block search_bar %}
<div class="search">
    <i class="ri-search-line"></i>
    <input type="text" placeholder="Search assets..." id="searchInput">
</div>
{% endblock search_bar %}

{% block body %}
<h3 class="page-title">Assets Overview</h3>
<p class="p-name">Last updated: {{ last_updated }}</p>

<div id="asset-inventory-section">
    <div class="board-top">
        <div class="left">
            <span class="board-title">Asset Inventory</span>
        </div>
        <div class="right">
            <div class="filter-container">
                <button id="filterBtn" class="filter-btn"><i class="ri-filter-3-fill"></i>Filter</button>
                <div id="filterPanel" class="filter-panel">
                    <div class="filter-heading">
                        <h3>Filter Assets</h3>
                    </div>
                    <div class="status-section">
                        <label>Status</label><br>
                        <div class="check-boxs">
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-ok" value="ok">
                                <label for="filter-ok">Ok</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-warning" value="warning">
                                <label for="filter-warning">Warning</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-critical" value="critical">
                                <label for="filter-critical">Critical</label>
                            </div>
                        </div>
                    </div>
                    <div class="type-section">
                        <label>Type</label><br>
                        <div class="check-boxs">
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-server" value="server">
                                <label for="filter-server">Server</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-storage" value="storage">
                                <label for="filter-storage">Storage</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-others" value="others">
                                <label for="filter-others">Others</label>
                            </div>
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="clear-btn" id="clearFilter">Clear</button>
                        <button class="apply-btn" id="applyFilter">Apply Filters</button>
                    </div>
                </div>
            </div>
            <div class="export-dropdown-container">
                <button class="export-btn" id="exportToggle"><i class="ri-download-line"></i>Export</button>
                <div class="export-dropdown" id="exportDropdown">
                    <a href="#" id="exportCSV">Export as CSV</a>
                    <a href="#" id="exportPDF">Export as PDF</a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="board">
    <div class="table-container">
        <table id="asset-table" width="100%">
            <thead>
                <tr>
                    <td>Asset</td>
                    <td>Type</td>
                    <td>Device name</td>
                    <td>Status</td>
                    <td>Cpu</td>
                    <td>Memory</td>
                    <td>Storage</td>
                </tr>
            </thead>
            <tbody>
                {% for asset in assets %}
                <tr class="asset-row" data-index="{{ loop.index0 }}" data-status="{{ asset.health_status|lower }}">
                    <td class="Asset">
                        <p>{{ asset.asset_id }}</p>
                    </td>
                    <td class="Type">
                        <p>{{ asset.type }}</p>
                    </td>
                    <td class="Device_name">
                        <p>{{ asset.device_name }}</p>
                    </td>
                    <td class="Status">
                        <div class="status-indicator {{ asset.health_status|lower }}">
                            <span class="dot"></span>
                            <span>{{ asset.health_status }}</span>
                        </div>
                    </td>
                    <td class="Cpu">
                        <p>{{ asset.cpu_usage_percent }}%</p>
                    </td>
                    <td class="Memory">
                        <div class="storage-wrapper">
                            <div class="label-row">
                                <span class="label">Memory</span>
                                <span class="percent">{{ asset.memory_usage_percent }}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill"
                                    style="width: {{ asset.memory_usage_percent }}%; background-color: {{ asset.memory_color }};">
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="Storage">
                        <p>{{ asset.storage_usage_percent }}%</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tbody id="no-results-message" style="display: none;">
                <tr>
                    <td colspan="7" style="text-align: center; font-weight: bold;">No assets found.</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="pagination">
        <span id="pagination-info"></span>
        <div class="pagination-buttons">
            <button id="prev-btn" disabled>
                <i class="ri-arrow-left-s-line"></i> Previous
            </button>
            <button id="next-btn">
                Next <i class="ri-arrow-right-s-line"></i>
            </button>
        </div>
    </div>
</div>
<div id="assetModal" class="modal hidden">
    <div class="modal-content">
        <div class="model-header">
            <h2 id="modal-asset-id"></h2>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="info-section">
                <h3>Asset Information</h3>
                <p><strong>Device:</strong> <span id="modal-device"></span></p>
                <p><strong>Type:</strong> <span id="modal-type"></span></p>
                <p><strong>Model:</strong> <span id="modal-model"></span></p>
                <p><strong>Firmware:</strong> <span id="modal-firmware"></span></p>
                <p><strong>Temperature:</strong> <span id="modal-temp"></span></p>
                <p><strong>Status:</strong> <span id="modal-health"></span></p>
                <p><strong>Contract Expiry:</strong> <span id="modal-contract"></span></p>
            </div>
            <div class="metric-section">
                <h3>Performance Metrics</h3>
                <div class="storage-wrapper">
                    <div class="label-row">
                        <span class="label">CPU Usage</span>
                        <span id="modal-cpu-percent" class="percent"></span>
                    </div>

                    <div class="progress-bar">
                        <div id="modal-cpu-bar" class="progress-fill"></div>
                    </div>
                </div>
                <div class="storage-wrapper" style="margin-top: 10px;">
                    <div class="label-row">
                        <span class="label">Memory Usage</span>
                        <span id="modal-memory-percent" class="percent"></span>
                    </div>
                    <div class="progress-bar">
                        <div id="modal-memory-bar" class="progress-fill"></div>
                    </div>
                </div>
                <div class="storage-wrapper" style="margin-top: 10px;">
                    <div class="label-row">
                        <span class="label">Storage Usage</span>
                        <span id="modal-storage-percent" class="percent"></span>
                    </div>
                    <div class="progress-bar">
                        <div id="modal-storage-bar" class="progress-fill"></div>
                    </div>
                </div>
                <p class="uptime">Uptime: <span id="modal-uptime"></span><span>hours</span></p>
            </div>
        </div>
    </div>
</div>
<script>
    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("input", function () {
        const query = searchInput.value.toLowerCase();

        filteredRows = rows.filter(row => {
            const assetCell = row.querySelector("td.Asset p");
            return assetCell && assetCell.textContent.toLowerCase().includes(query);
        });

        currentPage = 1;
        renderTable();
    });

    const assetData = {{ assets | tojson }};
    const rowsPerPage = 10;
    const table = document.querySelector("table tbody");
    const rows = Array.from(table.querySelectorAll("tr"));
    const paginationInfo = document.getElementById("pagination-info");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");

    let currentPage = 1;
    let filteredRows = [...rows];

    function renderTable() {
        const totalRows = filteredRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const noResultsMessage = document.getElementById("no-results-message");

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        rows.forEach(row => row.style.display = "none");

        if (totalRows === 0) {
            noResultsMessage.style.display = "";
            paginationInfo.textContent = "No results";
        } else {
            noResultsMessage.style.display = "none";

            filteredRows.slice(start, end).forEach(row => {
                row.style.display = "";
            });

            paginationInfo.textContent = `Showing ${start + 1} to ${Math.min(end, totalRows)} of ${totalRows} results`;
        }
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage >= totalPages || totalPages === 0;
    }

    prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    nextBtn.addEventListener("click", () => {
        const totalRows = filteredRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    });

    renderTable();

    function openModal(asset) {
        document.getElementById("modal-asset-id").innerText = asset.asset_id;
        document.getElementById("modal-device").innerText = asset.device_name;
        document.getElementById("modal-type").innerText = asset.type;
        document.getElementById("modal-model").innerText = asset.model;
        document.getElementById("modal-firmware").innerText = asset.firmware_version;
        document.getElementById("modal-health").innerText = asset.health_status;
        document.getElementById("modal-contract").innerText = asset.contract_expiry;
        document.getElementById("modal-temp").innerText = asset.temp;
        document.getElementById("modal-cpu-percent").innerText = asset.cpu_usage_percent + "%";
        document.getElementById("modal-cpu-bar").style.width = asset.cpu_usage_percent + "%";
        document.getElementById("modal-cpu-bar").style.backgroundColor = asset.cpu_color;

        // Memory Bar
        document.getElementById("modal-memory-percent").innerText = asset.memory_usage_percent + "%";
        document.getElementById("modal-memory-bar").style.width = asset.memory_usage_percent + "%";
        document.getElementById("modal-memory-bar").style.backgroundColor = asset.memory_color;

        // Memory Bar
        document.getElementById("modal-storage-percent").innerText = asset.storage_used + " / " + asset.storage_total + " TB";
        document.getElementById("modal-storage-bar").style.width = asset.storage_usage_percent + "%";
        document.getElementById("modal-storage-bar").style.backgroundColor = asset.storage_color;
        document.getElementById("modal-uptime").innerText = asset.uptime_hours;
        document.getElementById("assetModal").classList.remove("hidden");
    }

    function closeModal() {
        document.getElementById("assetModal").classList.add("hidden");
    }

    if (assetData.length > 0) {
        document.querySelectorAll(".asset-row").forEach(row => {
            row.addEventListener("click", function () {
                const index = this.getAttribute("data-index");
                const asset = assetData[index];
                openModal(asset);
            });
        });
    }

    const filterBtn = document.getElementById("filterBtn");
    const filterPanel = document.getElementById("filterPanel");

    filterBtn.addEventListener("click", (e) => {
        e.stopPropagation();

        const isFilterVisible = filterPanel.style.display === "block";
        exportDropdown.style.display = "none";
        filterPanel.style.display = isFilterVisible ? "none" : "block";
    });

    document.addEventListener("click", function (event) {
        if (!filterPanel.contains(event.target) && !filterBtn.contains(event.target)) {
            filterPanel.style.display = "none";
        }
    });

    // apply filter
    const applyBtn = document.getElementById("applyFilter") || document.querySelector(".apply-btn");
    const clearBtn = document.getElementById("clearFilter") || document.querySelector(".clear-btn");

    applyBtn.addEventListener("click", () => {
        const ok = document.getElementById("filter-ok").checked;
        const warning = document.getElementById("filter-warning").checked;
        const critical = document.getElementById("filter-critical").checked;

        const server = document.getElementById("filter-server").checked;
        const storage = document.getElementById("filter-storage").checked;
        const others = document.getElementById("filter-others").checked;

        filteredRows = rows.filter(row => {
            const status = row.getAttribute("data-status");
            const type = row.querySelector(".Type p").textContent.toLowerCase();

            const statusMatch = (ok && status === "ok") ||
                (warning && status === "warning") ||
                (critical && status === "critical");

            const typeMatch = (server && type === "server") ||
                (storage && type === "storage") ||
                (others && type !== "server" && type !== "storage");

            const statusChecked = ok || warning || critical;
            const typeChecked = server || storage || others;

            if (!statusChecked && !typeChecked) {
                return true;
            } else if (statusChecked && !typeChecked) {
                return statusMatch;
            } else if (!statusChecked && typeChecked) {
                return typeMatch;
            } else {
                return statusMatch && typeMatch;
            }
        });
        currentPage = 1;
        renderTable();

        filterPanel.style.display = "none";
    });

    clearBtn.addEventListener("click", () => {
        document.getElementById("filter-ok").checked = false;
        document.getElementById("filter-warning").checked = false;
        document.getElementById("filter-critical").checked = false;
        document.getElementById("filter-server").checked = false;
        document.getElementById("filter-storage").checked = false;
        document.getElementById("filter-others").checked = false; // Add this line

        filteredRows = [...rows];
        currentPage = 1;
        renderTable();

        filterPanel.style.display = "none";
    });


    function getFilteredAssetData() {
        const ok = document.getElementById("filter-ok").checked;
        const warning = document.getElementById("filter-warning").checked;
        const critical = document.getElementById("filter-critical").checked;
        const server = document.getElementById("filter-server").checked;
        const storage = document.getElementById("filter-storage").checked;
        const others = document.getElementById("filter-others").checked;

        const statusChecked = ok || warning || critical;
        const typeChecked = server || storage || others;

        return assetData.filter(asset => {
            const status = asset.health_status.toLowerCase();
            const type = asset.type.toLowerCase();

            const statusMatch = (ok && status === "ok") ||
                (warning && status === "warning") ||
                (critical && status === "critical");

            const typeMatch = (server && type === "server") ||
                (storage && type === "storage") ||
                (others && type !== "server" && type !== "storage");

            if (!statusChecked && !typeChecked) return true;
            else if (statusChecked && !typeChecked) return statusMatch;
            else if (!statusChecked && typeChecked) return typeMatch;
            else return statusMatch && typeMatch;
        });
    }


    //  PDF Export Button (filtered data)
    document.getElementById("exportPDF").addEventListener("click", () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const filteredData = getFilteredAssetData();
        const headers = [
            ["Asset ID", "Type", "Device Name", "Status", "CPU", "Memory", "Storage"]
        ];

        const rows = filteredData.map(asset => [
            asset.asset_id,
            asset.type,
            asset.device_name,
            asset.health_status,
            asset.cpu_usage_percent + "%",
            asset.memory_usage_percent + "%",
            asset.storage_usage_percent + "%"
        ]);

        doc.autoTable({
            head: headers,
            body: rows,
            startY: 20,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [52, 73, 94] },
            theme: 'striped',
        });
        doc.save('Asset_inventory.pdf');
    });

    //  CSV Export Button (filtered data)
    document.getElementById("exportCSV").addEventListener("click", () => {
        const filteredData = getFilteredAssetData();
        const headers = ["Asset ID", "Type", "Device Name", "Status", "CPU", "Memory", "Storage"];
        const rows = filteredData.map(asset => [
            asset.asset_id,
            asset.type,
            asset.device_name,
            asset.health_status,
            asset.cpu_usage_percent + "%",
            asset.memory_usage_percent + "%",
            asset.storage_usage_percent + "%"
        ]);

        let csvContent = "data:text/csv;charset=utf-8,"
            + headers.join(",") + "\n"
            + rows.map(e => e.join(",")).join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "Asset_inventory.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    //  Toggle export dropdown
    const exportToggle = document.getElementById("exportToggle");
    const exportDropdown = document.getElementById("exportDropdown");

    exportToggle.addEventListener("click", function (e) {
        e.stopPropagation();

        const isExportVisible = exportDropdown.style.display === "block";
        filterPanel.style.display = "none";
        exportDropdown.style.display = isExportVisible ? "none" : "block";
    });

    document.addEventListener("click", function (event) {
        if (!exportDropdown.contains(event.target) && !exportToggle.contains(event.target)) {
            exportDropdown.style.display = "none";
        }
        if (!filterPanel.contains(event.target) && !filterBtn.contains(event.target)) {
            filterPanel.style.display = "none";
        }
    });
</script>

{% endblock body %}